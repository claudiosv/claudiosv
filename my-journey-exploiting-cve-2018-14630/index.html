<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>My Journey Exploiting CVE-2018-14630 - Claudio Spiess</title><meta property="og:title" content="My Journey Exploiting CVE-2018-14630 - Claudio Spiess"><meta property="og:type" content="article"><meta property="og:image" content="img/profile.jpg"><meta property="og:url" content="https://claudiosv.github.io/blog/my-journey-exploiting-cve-2018-14630/"><meta property="og:description" content="TEST"><meta name=Description property="description" content="TEST"><meta property="keywords" content="untagged"><link rel=stylesheet href=https://claudiosv.github.io/blog/css/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link href=https://claudiosv.github.io/blog/index.xml type=application/atom+xml rel=alternate title="Sitewide Atom feed"><meta name=theme-color content="#ffffff"><script>function updateMode(){localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function toggleMode(){localStorage.theme==="dark"?localStorage.theme="light":localStorage.theme="dark",updateMode()}window.onload=updateMode();function toggleMenu(){let e=document.getElementById("navbar-default");e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")}</script></head><body><header class="md:px-0 px-2"><nav><div class="container flex flex-wrap justify-between items-center mx-auto"><div class="nav-main my-2.5"></div><button type=button onclick=toggleMenu() class="inline-flex items-center p-2 ml-3
text-sm text-gray-500
rounded-lg md:hidden hover:bg-gray-100
focus:outline-none focus:ring-2
focus:ring-gray-200 dark:text-gray-400
dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls=navbar-default aria-expanded=false>
<span class=sr-only>Open main menu</span><svg class="w-6 h-6" aria-hidden="true" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></button><div class="hidden w-full md:block md:w-auto" id=navbar-default><ul class="grid md:grid-flow-col items-center justify-between text-lg my-2.5"><li class="p-2.5 md:first:pl-0 md:border-none border-b dark:border-zinc-500 list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/blog/>Home</a></li><li class="p-2.5 md:first:pl-0 md:border-none border-b dark:border-zinc-500 list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/blog/post/>Posts</a></li><li class="h-7 pl-2.5 pr-0 list-none"><button type=button onclick=toggleMode() class=h-full aria-label="Toggle between dark and light mode">
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 hidden dark:inline" id=ligh-mode-button-img alt="A sun icon for switching to light mode" src=https://claudiosv.github.io/blog/img/light_mode.svg>
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 inline dark:hidden" id=dark-mode-button-img alt="A moon icon for switching to dark mode" src=https://claudiosv.github.io/blog/img/dark_mode.svg></button></li></ul></div></div></nav></header><main class="content h-card container mt-2 m-auto
leading-loose md:px-0 px-2 z-0" role=main><article class="article h-entry" itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><div class=title-container><h1 class="article-title p-name" itemprop=name>My Journey Exploiting CVE-2018-14630</h1><div class="flex justify-between items-center"><a class="text-lg text-gray-600 dark:text-gray-400 border-none u-url" href=https://claudiosv.github.io/blog/my-journey-exploiting-cve-2018-14630/><time itemprop=datePublished class=dt-published datetime=2019-05-08T14:28:32+0200 content="2019-05-08T14:28:32+0200">2019.05.08</time></a>
<a class="text-gray-600 dark:text-gray-400 text-right border-none p-author h-card" rel=author href=https://claudiosv.github.io/blog/ itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>Claudio Spiess</span></a></div></div><div class="article-content e-content" itemprop=articleBody><p>As part of a course on Information Security, part of the course assesment came from a semester project. We had to exploit an application, preferably a web application, of our choice. Given that our university uses the Moodle platform for the course web pages, Moodle became an obvious first choice. Moodle is an excellent target because it is an old project, written in PHP, full of obscure features that are questionably maintained. Therefore it has a huge attack surface, and there are plenty of known vulnerabilities to exploit. Besides, PHP makes it easy to write insecure code: plenty of dynamic-language fun like eval() and unserialize(), magic methods, an extremely poor type system, and a long legacy of functions that require input sanitization before use.</p><p>While I had no trouble exploiting several XSS vulnerabilities, which make for great session stealers, and implementing a published SQL / Privilege Escalation exploits, when I started trying to <a href=https://sec-consult.com/en/blog/advisories/remote-code-execution-php-unserialize-moodle-open-source-learning-platform-cve-2018-14630/>CVE-2018-14630</a> I ran into problems. I was using Moodle 3.2, which is not on the vulnerable list of this exploit despite not receiving the vendor patch. I downgraded to 3.1.13, and it still didn&rsquo;t work, which wasn&rsquo;t surprising considering that it had the exact same vulnerable code.</p><p>I uploaded the Proof of Concept XML into the question importer, and the very first problem I ran into was simple.
<img src=https://i.imgur.com/SXQdfic.png alt>
You can&rsquo;t have any whitespace in your serialized string.
<img src=https://i.imgur.com/fzI6FHz.png alt></p><p>Next, I found that Moodle was trying to access an object in the payload that isn&rsquo;t defined. At this point I thought it was a pretty poor Proof of Concept, since it could never have worked without this simple addition.
<img src=https://i.imgur.com/wU9pYXf.png alt></p><p>No problem, I simply added the object to the payload.
<img src=https://i.imgur.com/IKJ6G6I.png alt></p><p>Progress!</p><p><img src=https://i.imgur.com/60izAnD.png alt></p><p>Sucess? Not really, if the payload had run, we would&rsquo;ve gotten the username running the PHP interpreter. Now there&rsquo;s no errors, at least. To get to the bottom of this, I added a strategic <code>var_dump()</code> in the vulnerable Moodle code, to find this:
<img src=https://i.imgur.com/5FkcpPD.png alt></p><p>If you&rsquo;re a sharp reader, you would notice that the keys from the payload are duplicated, there&rsquo;s <code>"key":protected</code> and <code>"key"</code>. Clearly, the PHP interpreter references the protected variables as Moodle executes, and our payload never gets executed.</p><p>To understand why this is happening, we need to understand how PHP serializes objects. If an object is public, it&rsquo;s name is written as it is: <code>s:5:"slots"</code>, where <code>s</code> is the type (string), <code>5</code> is the length of the variable, the <code>"slots"</code> is the name. The object following it is the value of this variable, in our case <code>a:1:{i:0;i:1337;}</code>. Same spiel: a for array, 1 for its length, braces for its members, i for integer, first integer is the index, the second is the value. All objects follow this pattern, but if a variable is private, its name is written in the format &ldquo;\0NAME\0&rdquo;, where \0 is the NUL character. Protected variables are prepended with <code>\0*\0</code>, that&rsquo;s an asterisk surrounded by NULs.</p><p>Clearly, when this payload was written, this was not taken in to account. My next step was to correct the payload so that all the variable lengths are incremented by 3 for the 3 new characters I prepend to all the variable names (the <code>\0*\0</code>). But I quickly ran into a roadblock I could not pass: XML is relatively forgiving, but one rule that can never be broken is that you can never have a NUL character in a valid XML file. Therefore, Moodle&rsquo;s XML parser would immediatly stop upon the first <code>\0</code>. To confirm my theory, I modified Moodle&rsquo;s source code to directly load my payload rather than the user uploaded file, and it worked!</p><p>My second approach, was to change all the protected variables in Moodle to public variables, allowing the payload without any protected variables to work.</p><p><img src=https://i.imgur.com/7CsdZW9.png alt></p><p>Sucess! Our payload ran.</p></div><ul class="list-none pl-0 font-sm align-left"><li class=list-none>Tags:
<a class="inline-block mt-2 mr-2 border-none text-neutral-800 dark:text-neutral-200" href=/blog/tags/untagged><span class="flex flex-row justify-start items-center
dark:bg-zinc-900 dark:hover:bg-zinc-700
hover:bg-zinc-300 bg-zinc-200
dark:border-zinc-600 py-0.5
px-1 rounded-t border-b-2 border-zinc-300
hover:border-zinc-500"><img class="h-4 mr-2 inline" src=https://claudiosv.github.io/blog/images/tag_logo.svg alt="Logo of a tag: indicates that a tag item follows.">
untagged</span></a></li></ul><div class="text-neutral-500 mb-4">Last modified <span itemprop=dateModified datetime=2019-05-08T14:28:32+0200 content="2019-05-08T14:28:32+0200">2019.05.08</span></div></article></main><footer class="footer container h-10 text-center mt-1"><hr class=my-4><ul class="pl-0 mt-1"><li class="ml-2 first:before:content-none before:content-['•']
inline-block list-none">Made with ❤️ in Davis</li><li class="ml-2 first:before:content-none before:content-['•']
text-neutral-800 dark:text-neutral-400 inline-block list-none"><span class=ml-2>© Claudio Spiess 2023</span></li></ul></footer></body></html>